<?xml version="1.0" encoding="UTF-8" ?>
<odoo>
    <!--Maintenance Plan views-->
    <data>
        <!--Form view-->
        <record id="vtt_view_form_maintenance_plan" model="ir.ui.view">
            <field name="name">Maintenance Plan Form</field>
            <field name="model">vtt.maintenance.plan</field>
            <field name="arch" type="xml">
                <form>
                    <header>
                        <button name="action_start_plan" type="object" string="Start" class="btn-primary" invisible="state == 'run'"/>
                        <button name="renew_plan_by_last" type="object" string="Renew" class="btn-primary" invisible="state != 'run'"/>
                        <button name="action_close_plan" type="object" string="Close" invisible="state != 'run'"/>
                        <field name="state" widget="statusbar"/>
                    </header>
                    <sheet>
                        <!--<div class="oe_button_box" name="button_box">
                            <button name="action_view_repair" type="object"
                                class="oe_stat_button" icon="fa-wrench"
                                invisible="repair_order_count == 0">
                                <div class="o_stat_info">
                                    <field name="repair_order_count" class="o_stat_value"/>
                                    <span class="o_stat_text">Repairs</span>
                                </div>
                            </button>
                        </div>-->

                        <!--Ribbons-->
                        <widget name="web_ribbon" title="To Renew" bg_color="text-bg-warning" invisible="not need_renew"/>

                        <!--Invisible fields-->
                        <field name="need_renew" invisible="1"/>
                        <field name="plan_this_month" invisible="1"/>
                        <field name="plan_next_month" invisible="1"/>

                        <div class="oe_title">
                            <label for="name"/>
                            <h1>
                                <field name="name" readonly="1"/>
                            </h1>
                        </div>

                        <group>
                            <group>
                                <field name="partner_id" widget="res_partner_many2one" context="{'res_partner_search_mode': 'customer', 'show_address': 1, 'show_vat': True}"/>
                                <field name="phone"/>
                                <field name="email"/>
                            </group>
                            <group string="Maintenance Planning">
                                <field name="type"/>
                                <field name="plan_type_id"/>
                                <field name="dt_plan"/>
                                <field name="dt_last" invisible="1"/>
                            </group>
                            <group>
                                <field name="equipment_id" domain="[('partner_id', '=', partner_id)]" context="{'default_partner_id': partner_id}"/>
                                <field name="equipment_model_name"/>
                                <field name="equipment_manufacture"/>
                                <field name="equipment_manufacture_year"/>
                                <field name="equipment_serial_number"/>
                                <field name="equipment_date_warranty"/>
                            </group>
                            <group string="Related Part" invisible="type != 'parts'">
                                <field name="product_id"/>
                            </group>
                        </group>

                        <label for="note"/>
                        <field name="note"/>
                    </sheet>
                    <div class="oe_chatter">
                        <field name="message_follower_ids"/>
                        <field name="activity_ids"/>
                        <field name="message_ids"/>
                    </div>
                </form>
            </field>
        </record>

        <!--Tree view-->
        <record id="vtt_view_tree_maintenance_plan" model="ir.ui.view">
            <field name="name">Maintenance Plan List</field>
            <field name="model">vtt.maintenance.plan</field>
            <field name="arch" type="xml">
                <tree decoration-danger="plan_this_month" decoration-warning="plan_next_month" decoration-bf="plan_this_month">
                    <field name="name"/>
                    <field name="dt_plan" widget="date"/>
                    <field name="partner_id"/>
                    <field name="equipment_id"/>
                    <field name="activity_ids" widget="list_activity" optional="show"/>
                    <field name="type"/>
                    <field name="product_id"/>
                    <field name="plan_type_id"/>
                    <field name="dt_last" optional="hide" column_invisible="1"/>
                    <field name="state" widget="badge" decoration-muted="state == 'draft'" decoration-success="state == 'run'" decoration-danger="state == 'close'"/>
                    <field name="need_renew" column_invisible="1"/>
                    <field name="plan_this_month" column_invisible="1"/>
                    <field name="plan_next_month" column_invisible="1"/>
                </tree>
            </field>
        </record>

        <!--Kanban view-->
        <record id="vtt_view_kanban_maintenance_plan" model="ir.ui.view">
            <field name="name">Maintenance Kanban</field>
            <field name="model">vtt.maintenance.plan</field>
            <field name="arch" type="xml">
                <kanban class="o_kanban_mobile">
                    <field name="name"/>
                    <field name="dt_plan"/>
                    <field name="partner_id"/>
                    <field name="equipment_id"/>
                    <field name="type"/>
                    <field name="product_id"/>
                    <field name="state"/>
                    <field name="plan_type_id"/>
                    <progressbar field="activity_state" colors="{&quot;planned&quot;: &quot;success&quot;, &quot;today&quot;: &quot;warning&quot;, &quot;overdue&quot;: &quot;danger&quot;}"/>
                    <templates>
                        <t t-name="kanban-box">
                            <div t-attf-class="oe_kanban_global_click">
                                <div class="o_kanban_record_top mb16">
                                    <div class="o_kanban_record_headings mt4">
                                        <strong><span t-esc="record.equipment_id.value"/></strong>
                                        <span class="o_kanban_record_subtitle"><span t-esc="record.partner_id.value"/></span>
                                    </div>
                                    <div>
                                        <strong>
                                            <field name="dt_plan" widget="date"/>
                                        </strong>
                                        <span class="o_kanban_record_subtitle" align="right"><t t-esc="record.plan_type_id.value"/></span>
                                    </div>

                                </div>

                                Type: <strong class="o_kanban_record_title"><span><span t-esc="record.type.value"/></span></strong>
                                <span t-if="record.type == 'parts'" t-esc="record.product_id.value"/>

                                <div class="o_kanban_record_bottom">
                                    <div class="oe_kanban_bottom_left text-muted">
                                    </div>
                                    <div class="oe_kanban_bottom_right">
                                        <field name="activity_ids" widget="kanban_activity"/>
                                        <field name="state" widget="label_selection" options="{'classes': {'draft': 'muted', 'close': 'danger', 'run': 'success'}}"/>
                                    </div>
                                </div>
                            </div>
                        </t>
                    </templates>
                </kanban>
            </field>
        </record>

        <!--Search view-->
        <record id="vtt_view_search_maintenance_plan" model="ir.ui.view">
            <field name="name">Maintenance Plan Filter</field>
            <field name="model">vtt.maintenance.plan</field>
            <field name="arch" type="xml">
                <search string="Maintenance Plan">
                    <field name="name" filter_domain="['|', ('partner_id.name', 'ilike', self), ('equipment_id.name', 'ilike', self)]" string="Name"/>
                    <field name="partner_id"/>
                    <field name="equipment_id"/>
                    <field name="display_name" filter_domain="[('dt_plan', 'ilike', self)]" string="Planned"/>
                    <!--<separator/>
                    <filter string="Need Renew" domain="[('type', '=', 'general')]" name="type_general"/>-->
                    <separator/>
                    <!--<filter string="Archived" domain="[('active', '=', False)]" name="inactive"/>-->
                    <filter string="General" domain="[('type', '=', 'general')]" name="type_general"/>
                    <filter string="Parts" domain="[('type', '=', 'parts')]" name="type_parts"/>
                    <separator/>
                    <filter string="Running Plan" domain="[('state', '=', 'run')]" name="state_run"/>
                    <filter string="Closed Plan" domain="[('state', '=', 'close')]" name="state_close"/>
                    <separator/>
                    <!--<filter string="This Month" domain="[('dt_plan', '&gt;=', (datetime.datetime.combine(context_today(), datetime.time(0,0,0)).to_utc()).strftime('%Y-%m-01 %H:%M:%S')), ('dt_plan', '&lt;', (datetime.datetime.combine(context_today() + relativedelta(months=1), datetime.time(0,0,0)).to_utc()).strftime('%Y-%m-01 %H:%M:%S'))]" name="filter_plan_this_month"/>
                    <filter string="Next Month" domain="[('dt_plan', '&gt;=', (datetime.datetime.combine(context_today() + relativedelta(months=1), datetime.time(0,0,0)).to_utc()).strftime('%Y-%m-01 %H:%M:%S')), ('dt_plan', '&lt;', (datetime.datetime.combine(context_today() + relativedelta(months=2), datetime.time(0,0,0)).to_utc()).strftime('%Y-%m-01 %H:%M:%S'))]" name="filter_plan_next_month"/>-->
                    <filter string="This Month" domain="[('plan_this_month', '!=', False)]" name="filter_plan_this_month"/>
                    <filter string="Next Month" domain="[('plan_next_month', '!=', False)]" name="filter_plan_this_month"/>
                    <separator/>
                    <filter string="Planned Date" name="filter_plan" date="dt_plan" default_period="this_year"/>
                    <separator/>
                    <filter string="Daily" domain="[('plan_type_id.period_type', '=', 'day')]" name="period_day"/>
                    <filter string="Monthly" domain="[('plan_type_id.period_type', '=', 'month')]" name="period_month"/>
                    <filter string="Yearly" domain="[('plan_type_id.period_type', '=', 'year')]" name="period_year"/>
                    <group expand="0" string="Group By...">
                        <filter string="Partner" name="groupby_partner" domain="[]" context="{'group_by': 'partner_id'}"/>
                        <filter string="Equipment" name="groupby_equipment" domain="[]" context="{'group_by': 'equipment_id'}"/>
                        <filter string="Maintenance Type" name="groupby_type" domain="[]" context="{'group_by': 'type'}"/>
                        <filter string="Planned Date" name="groupby_dt_plan" domain="[]" context="{'group_by': 'dt_plan:month'}"/>
                        <filter string="Status" name="groupby_state" domain="[]" context="{'group_by': 'state'}"/>
                    </group>
                </search>
            </field>
        </record>
    </data>

    <!--Actions-->
    <data>
        <record id="vtt_act_window_maintenance_plan" model="ir.actions.act_window">
            <field name="name">Maintenance Plan List</field>
            <field name="res_model">vtt.maintenance.plan</field>
            <field name="view_mode">tree,form,kanban,activity</field>
        </record>
    </data>

    <!--Menus-->
    <data>
        <menuitem id="vtt_menu_repair_maintenance"
                  name="Maintenance"
                  parent="vtt_menu_repair_root"
                  sequence="30"/>
        <menuitem id="vtt_menu_repair_maintenance_maintenance"
                  name="Maintenance"
                  action="vtt_act_window_maintenance_plan"
                  parent="vtt_menu_repair_maintenance"
                  sequence="10"/>
        <menuitem id="vtt_menu_repair_equipment_part"
                  name="Consume Parts"
                  action="sale.product_template_action"
                  parent="vtt_menu_repair_equipment"
                  sequence="20"/>
    </data>
</odoo>