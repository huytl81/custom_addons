<?xml version="1.0" encoding="UTF-8" ?>
<odoo>
    <!--Repair Order views-->
    <data>
        <!--Form view-->
        <record id="vtt_view_form_repair_order" model="ir.ui.view">
            <field name="name">Repair Order Form</field>
            <field name="model">vtt.repair.order</field>
            <field name="arch" type="xml">
                <form>
                    <header>
                        <button name="action_confirm" type="object" string="Confirm" class="btn-primary" data-hotkey="q" invisible="state != 'new'"/>
                        <button name="action_create_diagnosis" type="object" string="Create Diagnosis" invisible="state in ('new', 'done', 'cancel')"/>
                        <button name="action_create_delivery" type="object" string="Create Delivery" class="btn-primary" invisible="state in ('new', 'done', 'cancel') or need_picking == False"/>
                        <button name="action_create_invoice" type="object" string="Create Invoice" class="btn-primary" invisible="state in ('new', 'done', 'cancel') or need_invoice == False"/>
                        <button name="action_start_repair" type="object" string="Start Repair" class="btn-primary" invisible="state != 'confirm'"/>
                        <button name="action_end_repair" type="object" string="Repair Done" class="btn-primary" invisible="state not in ('confirm', 'under_repair')"/>
                        <button name="action_done" type="object" string="Done" class="btn-primary" invisible="state not in ('repaired')"/>
                        <button name="action_cancel" type="object" string="Cancel" invisible="state not in ('new', 'confirm')"/>
                        <button name="action_draft" type="object" string="To Quotation" invisible="state not in ('cancel')"/>
                        <field name="state" widget="statusbar" statusbar_visible="new,confirm,under_repair,done"/>
                    </header>
                    <sheet>
                        <div class="oe_button_box" name="button_box">
                            <button name="action_view_diagnosis" type="object"
                                class="oe_stat_button" icon="fa-puzzle-piece"
                                invisible="diagnosis_count == 0">
                                <div class="o_stat_info">
                                    <field name="diagnosis_count" class="o_stat_value"/>
                                    <span class="o_stat_text">Diagnosis</span>
                                </div>
                            </button>
                            <button name="action_view_picking" type="object"
                                class="oe_stat_button" icon="fa-truck"
                                invisible="picking_count == 0">
                                <div class="o_stat_info">
                                    <field name="picking_count" class="o_stat_value"/>
                                    <span class="o_stat_text">Deliveries</span>
                                </div>
                            </button>
                            <button name="action_view_invoice" type="object" class="oe_stat_button" icon="fa-pencil-square-o" invisible="invoice_count == 0">
                                <field name="invoice_count" widget="statinfo" string="Invoices"/>
                            </button>
                            <button name="action_view_maintenance" type="object"
                                class="oe_stat_button" icon="fa-calendar-check-o"
                                invisible="not equipment_id">
                                <div class="o_stat_info">
                                    <span class="o_stat_text">Maintenance</span>
                                </div>
                            </button>
                            <button name="action_view_warranty" type="object"
                                class="oe_stat_button" icon="fa-ticket"
                                invisible="not equipment_id">
                                <div class="o_stat_info">
                                    <span class="o_stat_text">Warranty</span>
                                </div>
                            </button>
                        </div>

                        <!--Ribbons-->
                        <widget name="web_ribbon" title="Paid" invisible="payment_state != 'paid' or state not in ('repaired', 'done')"/>
                        <widget name="web_ribbon" title="Partial" invisible="payment_state != 'partial' or state not in ('repaired', 'done')"/>
                        <widget name="web_ribbon" title="Not Paid" bg_color="text-bg-danger" invisible="payment_state != 'not_paid' or state not in ('repaired', 'done')"/>
                        <widget name="web_ribbon" title="Cancel" bg_color="text-bg-muted" invisible="state not in ('cancel')"/>

                        <!--Invisible fields-->
                        <field name="payment_state" invisible="1"/>
                        <field name="need_picking" invisible="1"/>
                        <field name="need_invoice" invisible="1"/>

                        <div class="oe_title">
                            <field name="priority" widget="priority_switch" class="me-3"/>
                            <h1>
                                <field name="name" readonly="1"/>
                            </h1>
                        </div>

                        <group>
                            <group>
                                <field name="company_id" invisible="1"/>
                                <field name="currency_id" invisible="1"/>
                                <field name="partner_id" widget="res_partner_many2one" context="{'res_partner_search_mode': 'customer', 'show_address': 1, 'show_vat': True}"/>
                                <field name="partner_invoice_id" context="{'res_partner_search_mode': 'customer'}"/>
                                <field name="phone"/>
                                <field name="email"/>
                            </group>
                            <group>
                                <field name="dt_order"/>
                                <field name="recipient_id"/>
                                <field name="dt_diagnosis" invisible="1"/>
                                <field name="dt_confirm" invisible="state not in ('confirm', 'under_repair', 'repaired')"/>
                                <field name="dt_done" invisible="state not in ('done')"/>
                                <field name="user_id"/>
                                <field name="user_ids" invisible="1"/>
                                <field name="dt_deadline"/>
                            </group>
                            <group>
                                <field name="equipment_id" domain="[('partner_id', '=', partner_id)]" context="{'default_partner_id': partner_id}"/>
                                <div class="o_row" colspan="2">
                                    <!--<field name="equipment_id" domain="[('partner_id', '=', partner_id)]" context="{'default_partner_id': partner_id}"/>-->
                                    <button name="action_update_warranty" type="object" class="btn btn-primary fa fa-plus-square-o" aria-label="Update Warranty" title="Update Warranty" role="img" invisible="not equipment_id"/>
                                </div>
                                <!--<field name="equipment_id" domain="[('partner_id', '=', partner_id)]" context="{'default_partner_id': partner_id}"/>-->
                                <field name="equipment_model_name"/>
                                <field name="equipment_manufacture"/>
                                <field name="equipment_manufacture_year"/>
                                <field name="equipment_serial_number"/>
                            </group>
                            <group>
                                <field name="equipment_date_warranty"/>
                                <field name="is_under_warranty"/>
                            </group>
                        </group>
                        <label for="description"/>
                        <field name="description" nolabel="1"/>

                        <notebook>
                            <page name="lines" string="Details">
                                <field name="line_ids" widget="section_and_note_one2many">
                                    <tree editable="bottom">
                                        <control>
                                            <!--<create name="add_product_control" string="Add a product" context="{'default_product_type': 'product'}"/>
                                            <create name="add_service_control" string="Add a service" context="{'default_product_type': 'service'}"/>-->
                                            <create name="add_product_control" string="Add a product"/>
                                            <create name="add_section_control" string="Add a section" context="{'default_display_type': 'line_section'}"/>
                                            <create name="add_note_control" string="Add a note" context="{'default_display_type': 'line_note'}"/>
                                            <!--<button name="action_add_from_catalog" string="Catalog" type="object" class="px-4 btn-link" context="{'order_id': parent.id}"/>-->
                                        </control>
                                        <field name="display_type" column_invisible="1"/>
                                        <!--<field name="product_type" column_invisible="1"/>-->
                                        <field name="product_uom_category_id" column_invisible="True"/>
                                        <field name="sequence" widget="handle"/>
                                        <field name="name" widget="section_and_note_text" optional="show"/>
                                        <field name="product_id" domain="[('repair_order_ok', '=', True), '|', ('company_id', '=', False), ('company_id', '=', parent.company_id)]" widget="sol_product_many2one"/>
                                        <field name="uom_id" domain="[('category_id', '=', product_uom_category_id)]" optional="show" context="{'default_category_id': product_uom_category_id}"/>
                                        <field name="product_uom_qty"/>
                                        <field
                                            name="qty_delivered"
                                            string="Delivered"
                                            column_invisible="parent.state in ('new', 'cancel')"
                                            readonly="1"
                                            optional="hide"/>
                                        <field
                                            name="qty_invoiced"
                                            string="Invoiced"
                                            column_invisible="parent.state in ('new', 'cancel')"
                                            optional="hide"/>
                                        <field name="price_unit"/>
                                        <field
                                            name="tax_id"
                                            widget="many2many_tags"
                                            options="{'no_create': True}"
                                            domain="[('type_tax_use', '=', 'sale'), ('company_id', 'parent_of', parent.company_id)]"
                                            context="{'active_test': True}"
                                            optional="show"/>
                                        <field name="discount" string="Disc.%" optional="show"/>
                                        <field name="price_subtotal" string="Tax excl."/>
                                        <field name="price_total"
                                               string="Tax incl."
                                               optional="hide"/>
                                        <!--<field name="state" column_invisible="True"/>-->
                                        <field name="currency_id" column_invisible="True"/>
                                        <field name="price_tax" column_invisible="True"/>
                                        <field name="company_id" column_invisible="True"/>
                                    </tree>
                                </field>

                                <!--<div class="float-end d-flex gap-1 mb-2 ms-1"
                                     name="so_button_below_order_lines">
                                    <button string="Discount"
                                            name="action_open_discount_wizard"
                                            type="object"
                                            class="btn btn-secondary"
                                            groups="product.group_discount_per_so_line"/>
                                </div>-->
                                <group name="note_group" col="6" class="mt-2 mt-md-0">
                                    <group colspan="4">
                                        <field  colspan="2" name="note" nolabel="1" placeholder="Terms and conditions..."/>
                                    </group>
                                    <group class="oe_subtotal_footer" colspan="2" name="sale_total">
                                        <field name="tax_totals" widget="account-tax-totals-field" nolabel="1" colspan="2" readonly="1"/>
                                    </group>
                                    <div class="clearfix"/>
                                </group>
                            </page>

                            <page name="timesheets" string="Timesheets">
                                <field name="timesheet_line_ids" context="{'default_account_id': analytic_account_id, 'default_name': 'Work time'}">
                                    <tree editable="bottom">
                                        <field name="company_id" column_invisible="1"/>
                                        <field name="account_id" column_invisible="1"/>
                                        <field name="date"/>
                                        <field name="user_id"/>
                                        <!--<field name="partner_id" domain="[('user_ids', '!=', False)]" options="{'no_create': True}"/>-->
                                        <field name="partner_id" column_invisible="1"/>
                                        <field name="name"/>
                                        <field name="unit_amount" widget="float_time"/>
                                    </tree>
                                </field>
                            </page>

                            <page name="tech_info" string="Technical Information">
                                <field name="diagnosis_ids" invisible="1"/>
                                <field name="modify_available" invisible="1"/>
                                <group>
                                    <group>
                                        <field name="dt_start_repair"/>
                                        <field name="dt_end_repair"/>
                                        <field name="duration_repair" widget="float_time" readonly="1"/>
                                    </group>
                                    <group>
                                        <field name="duration_order" widget="float_time" readonly="1" invisible="state not in ('done')"/>
                                    </group>
                                </group>
                            </page>

                            <page name="other_info" string="Other Information">
                                <field name="picking_ids" invisible="1"/>
                                <field name="invoice_ids" invisible="1"/>
                                <field name="transaction_ids" invisible="1"/>
                                <group>
                                    <group>
                                        <field name="warehouse_id"/>
                                    </group>
                                    <group>
                                        <field name="fiscal_position_id"/>
                                        <field name="analytic_account_id"/>
                                        <field name="journal_id"/>
                                    </group>
                                    <group>
                                        <field name="tag_ids" widget="many2many_tags" options="{'color_field': 'color'}"/>
                                    </group>
                                </group>
                            </page>
                        </notebook>
                    </sheet>
                    <div class="oe_chatter">
                        <field name="message_follower_ids"/>
                        <field name="activity_ids"/>
                        <field name="message_ids"/>
                    </div>
                </form>
            </field>
        </record>

        <!--Trees view-->
        <record id="vtt_view_tree_repair_order" model="ir.ui.view">
            <field name="name">Repair Order List</field>
            <field name="model">vtt.repair.order</field>
            <field name="arch" type="xml">
                <tree decoration-muted="state == 'cancel'">
                    <field name="priority" widget="priority"/>
                    <field name="name"/>
                    <field name="dt_order"/>
                    <field name="partner_id"/>
                    <field name="equipment_id"/>
                    <field name="user_id" optional="show" widget="many2one_avatar_user"/>
                    <field name="activity_ids" widget="list_activity" optional="show"/>
                    <field name="company_id" groups="base.group_multi_company" optional="hide" readonly="1"/>
                    <field name="amount_untaxed" sum="Untaxed" widget="monetary" optional="hide"/>
                    <field name="amount_tax" sum="Taxes" widget="monetary" optional="hide"/>
                    <field name="amount_total" sum="Total" widget="monetary"/>
                    <field name="amount_paid" sum="Paid" widget="monetary" optional="hide"/>
                    <field name="amount_residual" sum="Due" widget="monetary" optional="hide"/>
                    <field name="tag_ids" widget="many2many_tags" options="{'color_field': 'color'}" optional="hide"/>
                    <field name="state" widget="badge" decoration-success="state in ('repaired', 'done')" decoration-info="state == 'new'" decoration-primary="state == 'confirm'"/>
                    <field name="payment_state" widget="badge" decoration-success="payment_state == 'paid'" decoration-warning="payment_state == 'partial'" decoration-danger="payment_state == 'not_paid'" optional="hide"/>
                    <field name="dt_confirm" optional="hide"/>
                    <field name="dt_done" optional="hide"/>
                    <field name="currency_id" column_invisible="1"/>
                </tree>
            </field>
        </record>

        <!--Kanban view-->
        <record id="vtt_view_kanban_repair_order" model="ir.ui.view">
            <field name="name">Repair Order Kanban</field>
            <field name="model">vtt.repair.order</field>
            <field name="arch" type="xml">
                <kanban class="o_kanban_mobile">
                    <field name="priority"/>
                    <field name="name"/>
                    <field name="dt_order"/>
                    <field name="partner_id"/>
                    <field name="equipment_id"/>
                    <field name="user_id"/>
                    <field name="amount_total"/>
                    <field name="tag_ids"/>
                    <field name="state"/>
                    <field name="dt_done" optional="hide"/>
                    <field name="currency_id"/>
                    <progressbar field="activity_state" colors="{&quot;planned&quot;: &quot;success&quot;, &quot;today&quot;: &quot;warning&quot;, &quot;overdue&quot;: &quot;danger&quot;}"/>
                    <templates>
                        <t t-name="kanban-box">
                            <div t-attf-class="oe_kanban_global_click">
                                <div class="o_kanban_record_top mb16">
                                    <div class="o_kanban_record_headings mt4">
                                        <field name="priority" widget="priority"/>
                                        <strong><field name="name"/></strong>
                                        <span class="o_kanban_record_subtitle"><span t-esc="record.partner_id.value"/></span>
                                    </div>
                                    <strong>
                                        <field name="amount_total" widget="monetary"/>
                                    </strong>
                                </div>

                                <field name="tag_ids" widget="many2many_tags" options="{'color_field': 'color'}"/>
                                <strong class="o_kanban_record_title"><span><t t-esc="record.equipment_id.value"/></span></strong>

                                <div class="o_kanban_record_bottom">
                                    <div class="oe_kanban_bottom_left text-muted">
                                        <span><t t-esc="record.dt_order.value"/></span>
                                        <field name="activity_ids" widget="kanban_activity"/>
                                    </div>
                                    <div class="oe_kanban_bottom_right">
                                        <field name="user_id" widget="many2one_avatar_user"/>
                                        <field name="state" widget="label_selection" options="{'classes': {'new': 'info', 'cancel': 'default', 'done': 'success', 'repaired': 'success', 'confirm': 'primary'}}"/>
                                    </div>
                                </div>
                            </div>
                        </t>
                    </templates>
                </kanban>
            </field>
        </record>

        <!--Search view-->
        <record id="vtt_view_search_repair_order" model="ir.ui.view">
            <field name="name">Repair Order Filter</field>
            <field name="model">vtt.repair.order</field>
            <field name="arch" type="xml">
                <search string="Repair Order">
                    <field name="name" filter_domain="['|', '|', ('name', 'ilike', self), ('partner_id.name', 'ilike', self), ('equipment_id.name', 'ilike', self)]" string="Name"/>
                    <field name="partner_id"/>
                    <field name="equipment_id"/>
                    <!--<field name="display_name" filter_domain="[('dt_plan', 'ilike', self)]" string="Planned"/>-->
                    <!--<separator/>
                    <filter string="Need Renew" domain="[('type', '=', 'general')]" name="type_general"/>-->
                    <separator/>
                    <!--<filter string="Archived" domain="[('active', '=', False)]" name="inactive"/>-->
                    <filter string="My Orders" domain="[('user_id', '=', uid)]" name="my_orders"/>
                    <separator/>
                    <filter string="Confirmed" domain="[('state', '=', 'confirm')]" name="state_confirm"/>
                    <filter string="Repairing" domain="[('state', '=', 'under_repair')]" name="state_repair"/>
                    <filter string="Repaired" domain="[('state', '=', 'repaired')]" name="state_repaired"/>
                    <filter string="Done" domain="[('state', '=', 'done')]" name="state_done"/>
                    <separator/>
                    <filter string="Order Date" name="filter_dt_order" date="dt_order" default_period="this_month"/>
                    <separator/>
                    <filter string="Close Date" name="filter_dt_done" date="dt_done" default_period="this_month"/>
                    <group expand="0" string="Group By...">
                        <filter string="Partner" name="groupby_partner" domain="[]" context="{'group_by': 'partner_id'}"/>
                        <filter string="Equipment" name="groupby_equipment" domain="[]" context="{'group_by': 'equipment_id'}"/>
                        <filter string="User" name="groupby_user" domain="[]" context="{'group_by': 'user_id'}"/>
                        <filter string="Order Date" name="groupby_dt_order" domain="[]" context="{'group_by': 'dt_order:month'}"/>
                        <filter string="Status" name="groupby_state" domain="[]" context="{'group_by': 'state'}"/>
                        <filter string="Payment Status" name="groupby_payment_state" domain="[]" context="{'group_by': 'payment_state'}"/>
                    </group>
                </search>
            </field>
        </record>
    </data>

    <!--Actions-->
    <data>
        <record id="vtt_act_window_repair_order" model="ir.actions.act_window">
            <field name="name">Repair Orders</field>
            <field name="res_model">vtt.repair.order</field>
            <field name="view_mode">tree,form,kanban,activity</field>
        </record>
    </data>

    <!--Menus-->
    <data>
        <menuitem id="vtt_menu_repair_root"
                  name="MRO"
                  sequence="40"
                  web_icon="vtt_mro,static/description/icon.png"/>
        <menuitem id="vtt_menu_repair_repair"
                  name="Repair Orders"
                  parent="vtt_menu_repair_root"
                  sequence="10"/>
        <menuitem id="vtt_menu_repair_equipment"
                  name="Equipment"
                  parent="vtt_menu_repair_root"
                  sequence="20"/>
        <menuitem id="vtt_menu_repair_report"
                  name="Reporting"
                  parent="vtt_menu_repair_root"
                  sequence="50"/>
        <!--<menuitem id="vtt_menu_repair_dashboard"
                  name="Dashboard"
                  parent="vtt_menu_repair_root"
                  sequence="60"/>-->
        <menuitem id="vtt_menu_repair_config"
                  name="Configurations"
                  parent="vtt_menu_repair_root"
                  sequence="100"/>

        <menuitem id="vtt_menu_repair_repair_order"
                  name="Repair Orders"
                  action="vtt_act_window_repair_order"
                  parent="vtt_menu_repair_repair"
                  sequence="10"/>

        <menuitem id="vtt_menu_repair_config_repair"
                  name="Repairs"
                  parent="vtt_menu_repair_config"
                  sequence="10"/>

        <menuitem id="vtt_menu_repair_config_maintenance"
                  name="Maintenance"
                  parent="vtt_menu_repair_config"
                  sequence="20"/>
    </data>
</odoo>